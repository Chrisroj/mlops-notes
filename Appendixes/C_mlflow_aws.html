<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Appendix C: MLflow on AWS - test-book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Module1/1_intro.html"><strong aria-hidden="true">1.</strong> Introduction to MLOps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Module1/2_aws.html"><strong aria-hidden="true">1.1.</strong> VM Instance in AWS</a></li><li class="chapter-item expanded "><a href="../Module1/3_dependencies.html"><strong aria-hidden="true">1.2.</strong> Install Dependencies</a></li><li class="chapter-item expanded "><a href="../Module1/4_overview.html"><strong aria-hidden="true">1.3.</strong> Course Overview</a></li><li class="chapter-item expanded "><a href="../Module1/5_maturity.html"><strong aria-hidden="true">1.4.</strong> MLOps Maturity Model</a></li></ol></li><li class="chapter-item expanded "><a href="../Module2/1_intro_exptracking.html"><strong aria-hidden="true">2.</strong> Introduction to Experiment tracking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Module2/2_start_mlflow.html"><strong aria-hidden="true">2.1.</strong> Getting Started with MLflow</a></li><li class="chapter-item expanded "><a href="../Module2/3_track_single.html"><strong aria-hidden="true">2.2.</strong> Tracking a Single Experiment</a></li><li class="chapter-item expanded "><a href="../Module2/4_track_hyper.html"><strong aria-hidden="true">2.3.</strong> Tracking a Multiples Experiments</a></li><li class="chapter-item expanded "><a href="../Module2/5_autologging.html"><strong aria-hidden="true">2.4.</strong> Autologging</a></li><li class="chapter-item expanded "><a href="../Module2/6_log_models.html"><strong aria-hidden="true">2.5.</strong> Log Models</a></li><li class="chapter-item expanded "><a href="../Module2/7_model_registry.html"><strong aria-hidden="true">2.6.</strong> Model Registry</a></li><li class="chapter-item expanded "><a href="../Module2/8_mlflow_benefits.html"><strong aria-hidden="true">2.7.</strong> MLflow: Benefits, Limitations and Alternatives</a></li></ol></li><li class="chapter-item expanded "><a href="../Appendixes/A_gcp.html"><strong aria-hidden="true">3.</strong> Appendix A: VM Instance in GCP</a></li><li class="chapter-item expanded "><a href="../Appendixes/B_conda.html"><strong aria-hidden="true">4.</strong> Appendix B: Conda Environments</a></li><li class="chapter-item expanded "><a href="../Appendixes/C_mlflow_aws.html" class="active"><strong aria-hidden="true">5.</strong> Appendix C: MLflow on AWS</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">test-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mlflow-on-aws"><a class="header" href="#mlflow-on-aws">MLflow on AWS</a></h1>
<p>This tutorials explains how to configure a MLflow remote tracking server on AWS. We will use an RDS database as the backend store and an S3 bucket as the artifact store.</p>
<p><strong>Note:</strong> While the <strong>backend store</strong> persists MLflow entities (runs, parameters, metrics, tags, notes, metadata, etc), the <strong>artifact store</strong> persists artifacts (files, models, images, in-memory objects, or model summary, etc).</p>
<ol>
<li>
<p>First, you need to <a href="https://aws.amazon.com/free">create an AWS account</a>. If you open a new account, AWS allows you to use some of their products for free but take into account that <strong>you may be charged for using the AWS services</strong>. More information <a href="https://youtu.be/rkKvzCskpLE">here</a> and <a href="https://aws.amazon.com/premiumsupport/knowledge-center/free-tier-charges/">here</a>.</p>
</li>
<li>
<p>Launch a new EC2 instance</p>
<p>Go to EC2 service and click in launch instance(orange button), now config the VM as:</p>
<ul>
<li>Name: <code>mlflow_tracking-server</code></li>
<li>Amazon Machine Image: <code>Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type</code></li>
<li>Architecture: <code>64-bit (x86)</code></li>
<li>Instance type: <code>t2.micro</code></li>
<li>Create and select a key pair:
<ul>
<li>Key pair name: <code>mlflow-key-pair</code></li>
<li>Key pair type: <code>RSA</code></li>
<li>Private key file format: <code>.pem</code></li>
</ul>
</li>
<li>Configure Storage: <code>1x 8 Gib gp2 Root Volume</code></li>
</ul>
<p>Finally, you have to edit the security group so the EC2 instance accepts SSH (port 22) and HTTP connections (port 5000) as follow:</p>
<ol>
<li>Go to EC2 instances </li>
<li>Click in Instance ID </li>
<li>Go to &quot;Security&quot; tab </li>
<li>Click in &quot;Security groups&quot;</li>
<li>Click in &quot;Edit inbound rules&quot; </li>
<li>Add a new rule as the image</li>
</ol>
<p><img src="../Images/Module2/mlflow_ec2.png" alt="conda_logo" /></p>
<p>Now you can connect to the VM using the steps in module 1</p>
<p><strong>Note:</strong> You can use the EC2 instance created in the module 1 but in that case you have to apply the last step(Editting the security group). </p>
</li>
<li>
<p>Create an S3 bucket to be used as the <strong>artifact store</strong></p>
<ol>
<li>Go to S3 and click on &quot;Create bucket&quot;</li>
<li>Fill Bucket name, for example with <code>mlflow-artifacts-remote</code></li>
<li>Click on &quot;Create bucket&quot;</li>
</ol>
<p><strong>Note:</strong> S3 bucket names must be unique across all AWS account in all the AWS Regions within a partition, that means that once a bucket is created, the name of that bucket cannot be used by another AWS account within the same region. If you get an error saying that the bucket name was already taken you can fix it easily by just changing the name to something like <code>mlflow-artifacts-remote-2</code> or another name.</p>
</li>
<li>
<p>Create a new PostgreSQL Database(To be used as the <strong>backend store</strong>)</p>
<p>Go to the RDS Console and click on &quot;Create database&quot; and choose the next configuration:</p>
<ul>
<li>Engine Options
<ul>
<li>Engine type: <code>PostgreSQL</code> </li>
<li>Version: <code>PostgreSQL 13.4-R1</code></li>
</ul>
</li>
<li>Templates: <code>Free tier</code></li>
<li>Settings
<ul>
<li>DB instance identifier: <code>mlflow-backend-db</code></li>
<li>Master username: <code>mlflow</code></li>
<li>Auto generate a password: Tick the option</li>
</ul>
</li>
<li>Additional configuration
<ul>
<li>Initial database name: <code>mlflow_db</code></li>
</ul>
</li>
</ul>
<p>You can use the default values for all the other configurations. Now click in &quot;Create database&quot;. Then you'll can view the credentials, its important that you save the credentials beacuse the password will be shown only once!</p>
<p><img src="../Images/Module2/mlflow_credentials.png" alt="conda_logo" /></p>
<p>Take note of the following information:</p>
<ul>
<li><strong>Master username</strong></li>
<li><strong>Master password</strong></li>
<li><strong>Initial database name</strong></li>
<li><strong>Endpoint</strong></li>
</ul>
<p>To get the endpoint <strong>Go to RDS -&gt; Go to DB intances -&gt; Click in the DB identifier -&gt; The endpoint is in the &quot;Connectivity &amp; security&quot; tab</strong>, the endpoint take some time to appear, be patient.</p>
<p>Once the DB instance is created, go to the RDS console, select the new db and under &quot;Connectivity &amp; security&quot; select the VPC security group. Modify the security group by adding a new inbound rule that allows postgreSQL connections on the port 5432 from the security group of the EC2 instance. </p>
<ol>
<li>In RDS go to DB instances</li>
<li>Click in the DB identifier</li>
<li>Go to &quot;Connectivity &amp; security&quot; tab and click in the &quot;VPC security groups&quot;</li>
<li>Click in &quot;Edit inbound rules&quot;</li>
<li>Add a rule as the image</li>
</ol>
<p><img src="../Images/Module2/mlflow_postgresql.png" alt="conda_logo" /></p>
<p>The security group in the right of the <code>Custom</code> should be the same as the security group of the EC2 instance, to know the security group of the EC2 instance:</p>
<ol>
<li>Go to EC2 and click in &quot;Instance ID&quot;</li>
<li>Go to the Security tab and in Security groups is what you want.</li>
</ol>
<p>This way, the server will be able to connect to the postgres database.</p>
<p><strong>Note0:</strong> Thick the option &quot;Auto generate a password&quot; will be Amazon RDS generate a password automatically.</p>
<p><strong>Note1:</strong> Setting a initial database name will be that RDS automatically creates an initial database for you.</p>
<p><strong>Note2:</strong> If you use this for a production project you can consider use a different template like a <code>Production</code> template.</p>
</li>
<li>
<p>Connect to the EC2 Instance and launch the Tracking Server.</p>
<p><strong>EC2 Connection</strong></p>
<p>Start the EC2 instance created in step 2, select it and click in connect and use the easy way click in &quot;EC2 instance connect&quot;.Run the following commands to install the dependencies, configure the environment and launch the server:</p>
<ul>
<li><code>sudo yum update</code></li>
<li><code>pip3 install mlflow boto3 psycopg2-binary</code></li>
<li><code>aws configure</code>   # You'll need to input your AWS credentials here
You will need to input:
<ul>
<li><code>AWS Access Key ID</code></li>
<li><code>AWS Secret Access Key</code></li>
<li><code>Default region name</code>: You can left unchange</li>
<li><code>Default output format</code>: You can left unchange</li>
</ul>
</li>
</ul>
<p>To get your AWS credentials, in the navigation bar on the upper right, choose your account name or number and then choose &quot;Security Credentials&quot;, then expand the &quot;Access keys (access key ID and secret access key)&quot; section, now click in &quot;Create New Access Key&quot; button an the credentials will appear, this is your only opportunity to save your secret access key. After you've saved your secret access key in a secure location, chose Close.</p>
<p>Before launching the server, check that the instance can access the s3 bucket created in the step number 3. To do that, just run this command from the EC2 instance: <code>aws s3 ls</code>. You should see the bucket listed in the result.</p>
<p><strong>Note:</strong> You can't have more than two credentials, if you want a new want you have to delete one.</p>
<p><strong>Launching the server</strong></p>
<pre><code class="language-bash">mlflow server -h 0.0.0.0 -p 5000 --backend-store-uri postgresql://DB_USER:DB_PASSWORD@DB_ENDPOINT:5432/DB_NAME --default-artifact-root s3://S3_BUCKET_NAME
</code></pre>
<ul>
<li><code>DB_USER</code>: The <strong>Master username</strong> that you took note</li>
<li><code>DB_PASSWORD</code>: The <strong>Password username</strong> that you took note</li>
<li><code>DB_ENDPOINT</code>: The <strong>Endpoint</strong> of the PostgreSQL Database</li>
<li><code>DB_NAME</code>: The name of the db</li>
<li><code>S3_BUCKET_NAME</code>: The bucket name in step 3</li>
</ul>
<p>Example:</p>
<ul>
<li><code>DB_USER</code>: mlflow</li>
<li><code>DB_PASSWORD</code>: PLMYm3uAUPumN7LXs0zx</li>
<li><code>DB_ENDPOINT</code>: mlflow-backend-db.cxtpca0hxwbo.us-east-2.rds.amazonaws.com</li>
<li><code>DB_NAME</code>: mlflow_db</li>
<li><code>S3_BUCKET_NAME</code>: mlflow-artifacts-remote-31</li>
</ul>
</li>
<li>
<p>Access the remote tracking server from your local machine.</p>
<p><strong>Access using the UI</strong></p>
<p>Open a new tab on your web browser and go to this address: <code>http://&lt;EC2_PUBLIC_DNS&gt;:5000</code> (you can find the instance's public DNS by checking the details of your instance in the EC2 Console).</p>
<p>For example:</p>
<pre><code>http://ec2-18-191-194-132.us-east-2.compute.amazonaws.com:5000
</code></pre>
<p><strong>Access using Python code</strong></p>
<p>Now you have configure the AWS credentials in the EC2 instance, if you want to use your localhost as the client you need to configure the AWS credentials as well.</p>
<p>Set credentials in the AWS credentials profile file on your local system, located at(if the directory doesn't exist you can create it):</p>
<ul>
<li>
<p><code>~/.aws/credentials</code> on Linux, macOS, or Unix</p>
</li>
<li>
<p><code>C:\Users\USERNAME\.aws\credentials</code> on Windows</p>
</li>
</ul>
<p>This file should contain lines in the following format:</p>
<pre><code class="language-conf">[default]
aws_access_key_id = your_access_key_id
aws_secret_access_key = your_secret_access_key
</code></pre>
<p>Substitute your own AWS credentials values for the values <em>your_access_key_id</em> and <em>your_secret_access_key</em>. Now this profile named as <code>default</code> can be use to set your credentials. </p>
<p><strong>Note:</strong> You can change the name of the profile is not mandatory to use <code>default</code> name.</p>
<p>Now you can acces from python code in your local host, you should be able to run:</p>
<pre><code class="language-python">import mlflow
import os

os.environ[&quot;AWS_PROFILE&quot;] = &quot;default&quot; # Fill in with your AWS profile. More info: https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/setup.html#setup-credentials

TRACKING_SERVER_HOST = &quot;ec2-3-135-9-149.us-east-2.compute.amazonaws.com&quot; # fill in with the public DNS of the EC2 instance
mlflow.set_tracking_uri(f&quot;http://{TRACKING_SERVER_HOST}:5000&quot;)
</code></pre>
<p>Traking a model:</p>
<pre><code class="language-python">from sklearn.linear_model import LogisticRegression
from sklearn.datasets import load_iris
from sklearn.metrics import accuracy_score

mlflow.set_experiment(&quot;my-experiment-1&quot;)

with mlflow.start_run():

    X, y = load_iris(return_X_y=True)

    params = {&quot;C&quot;: 0.1, &quot;random_state&quot;: 42}
    mlflow.log_params(params)

    lr = LogisticRegression(**params).fit(X, y)
    y_pred = lr.predict(X)
    mlflow.log_metric(&quot;accuracy&quot;, accuracy_score(y, y_pred))

    mlflow.sklearn.log_model(lr, artifact_path=&quot;models&quot;)
    print(f&quot;default artifacts URI: '{mlflow.get_artifact_uri()}'&quot;)
</code></pre>
<p>Using Model Registry:</p>
<pre><code class="language-python">from mlflow.tracking import MlflowClient
client = MlflowClient(f&quot;http://{TRACKING_SERVER_HOST}:5000&quot;)

run_id = client.list_run_infos(experiment_id='1')[0].run_id
mlflow.register_model(
    model_uri=f&quot;runs:/{run_id}/models&quot;,
    name='iris-classifier'
)
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Appendixes/B_conda.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Appendixes/B_conda.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
